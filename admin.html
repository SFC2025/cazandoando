<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link
      rel="preconnect"
      href="https://vtdwtjxadqtmwwhjjhey.supabase.co"
      crossorigin
    />
    <link
      rel="preconnect"
      href="https://vtdwtjxadqtmwwhjjhey.supabase.co/storage/v1/object/public"
      crossorigin
    />
    <meta name="robots" content="noindex,nofollow" />
    <title>Panel CazandoAndo</title>
    <link rel="stylesheet" href="./style.css?v=2025-07-10-1520" />
    <style>
      /* Base */
      body {
        font-family: system-ui, Arial, sans-serif;
        background: #0f172a;
        color: #e5e7eb;
        margin: 0;
      }
      .wrap {
        width: min(1320px, 96vw);
        margin: 24px auto;
      }
      .card {
        background: #0b0b0b;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        overflow-x: auto;
      }
      input,
      select,
      button {
        font: inherit;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 8px 10px;
        background: #111;
        color: #e5e7eb;
      }
      button {
        background: #ff7a00;
        border: 0;
        color: #111;
        font: inherit;
        font-size: 15px; /* fuerzo tamaño exacto */
        line-height: 24px; /* misma “altura de letra” */
        height: 40px;
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
        -webkit-appearance: none;
        appearance: none;
      }

      .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .right {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: flex-end;
      }
      .muted {
        opacity: 0.75;
      }

      /* Tabla cómoda (filas separadas) */
      table {
        width: 100%;
        min-width: 1120px;
        table-layout: fixed;
        border-collapse: separate;
        border-spacing: 0 8px;
      }
      thead th {
        position: sticky;
        top: 0;
        z-index: 3;
        background: #0b0b0b;
      }
      th,
      td {
        padding: 12px 14px;
        vertical-align: middle;
        border: 0;
      }
      tbody td {
        background: #0b0b0b;
      }
      tbody tr td:first-child {
        border-radius: 8px 0 0 8px;
      }
      tbody tr td:last-child {
        border-radius: 0 8px 8px 0;
      }
      tbody tr:hover td {
        background: #101010;
      }

      /* Inputs más cómodos */
      td input[type="text"],
      td input[type="number"] {
        width: 100%;
        height: 40px;
        padding: 8px 12px;
        font-size: 15px;
      }

      /* Anchos por columna */
      th:nth-child(1),
      td:nth-child(1) {
        width: 110px;
      } /* ID */
      th:nth-child(2),
      td:nth-child(2) {
        width: 170px;
      } /* Categoría */
      th:nth-child(3),
      td:nth-child(3) {
        width: 320px;
      } /* Título */
      th:nth-child(4),
      td:nth-child(4) {
        width: 140px;
      } /* Precio */
      th:nth-child(5),
      td:nth-child(5) {
        width: 120px;
      } /* Stock */
      th:nth-child(6),
      td:nth-child(6) {
        width: 380px; /* un poco más ancho */
      }

      th:nth-child(7),
      td:nth-child(7) {
        width: 180px;
      } /* Acciones */

      td:nth-child(6) img {
        max-height: 64px;
        border-radius: 8px;
      }
      /* Columna Foto un poco más ancha y botones pegados */
      td:nth-child(6),
      td:nth-child(6) {
        width: 380px;
      } /* + espacio para 2 botones */
      /* Foto: que "Elegir" y "Borrar foto" queden tan juntos como Guardar/Borrar */
      /* Foto: botones pegados, mismos tamaños y foco */
      td:nth-child(6) .row {
        gap: 8px;
        align-items: center;
        flex-wrap: nowrap;
      }

      /* el input ocupa solo el ancho del botón (sin “zona muerta”) */
      td:nth-child(6) input[type="file"] {
        width: 160px; /* evita cortar “archivo” */
        max-width: none;
        color: transparent; /* oculta el nombre del archivo */
        border: 0;
        outline: none; /* saca el contorno gris del control */
        padding: 0;
        background: transparent;
        overflow: hidden;
        flex: 0 0 auto;
      }

      /* estilamos el botón del file como un botón normal */
      td:nth-child(6) input[type="file"]::file-selector-button {
        width: 160px;
        height: 40px;
        padding: 8px 12px;
        border-radius: 10px;
        border: 0;
        background: #ff7a00;
        color: #111;
        font: inherit;
        font-size: 15px; /* igual que botones */
        line-height: 24px; /* igual que botones */
        text-align: center;
        cursor: pointer;
        -webkit-appearance: none;
        appearance: none;
      }

      /* mismo “ring” de foco que los otros */
      td:nth-child(6) input[type="file"]:focus-within::file-selector-button {
        box-shadow: 0 0 0 3px rgba(255, 208, 151, 0.55);
      }

      /* Botón “Borrar foto” con estilo consistente */
      .btn-del-photo {
        width: 160px;
        height: 40px;
        padding: 8px 12px;
        border-radius: 10px;
        border: 0;
        background: #6b7280;
        color: #fff;
        font: inherit;
        font-size: 15px; /* igual que los otros */
        line-height: 24px; /* igual que los otros */
        text-align: center;
        cursor: pointer;
        -webkit-appearance: none;
        appearance: none;
      }

      .btn-del-photo:focus-visible {
        outline: 0;
        box-shadow: 0 0 0 3px rgba(255, 208, 151, 0.55);
      }

      /* Responsive */
      @media (max-width: 1200px) {
        th:nth-child(3),
        td:nth-child(3) {
          width: 280px;
        } /* Título */
        th:nth-child(6),
        td:nth-child(6) {
          width: 240px;
        } /* Foto   */
      }
      /* Acciones: mismos anchos/altos y foco */
      td:nth-child(7) .right {
        gap: 8px;
      }
      td:nth-child(7) .right .save,
      td:nth-child(7) .right .del {
        width: 160px;
        height: 40px;
        padding: 8px 12px;
        border-radius: 10px;
        border: 0;
        font: inherit;
        font-weight: 800;
        text-align: center;
        cursor: pointer;
      }

      td:nth-child(7) .right .save {
        background: #ff7a00;
        color: #111;
      }
      td:nth-child(7) .right .del {
        background: #c0392b;
        color: #fff;
      }
      td:nth-child(7) .right .save:focus-visible,
      td:nth-child(7) .right .del:focus-visible {
        outline: 0;
        box-shadow: 0 0 0 3px rgba(255, 208, 151, 0.55);
      }
      /* Toast discreto (abajo, estilo pill) */
      .toast {
        position: fixed;
        left: 50%;
        bottom: 24px;
        transform: translateX(-50%);
        background: #0b0b0b;
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: #e5e7eb;
        padding: 10px 14px;
        border-radius: 999px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        z-index: 10000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
        font-weight: 600;
      }
      .toast.show {
        opacity: 1;
      }

      /* Modal de confirmación (override a prueba de superposiciones) */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: grid;
        place-items: center;
        z-index: 2147483647 !important; /* siempre arriba de todo */
      }
      .modal {
        position: relative;
        background: #0b0b0b;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 14px;
        padding: 18px;
        width: min(420px, 92vw);
        color: #e5e7eb;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
        z-index: 2147483647 !important;
        pointer-events: auto;
      }
      .modal * {
        pointer-events: auto;
      }

      .modal h3 {
        margin: 0 0 10px;
        font-size: 18px;
      }
      .modal p {
        margin: 0 0 16px;
        opacity: 0.9;
      }

      .modal .actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      .modal .btn {
        height: 40px;
        padding: 8px 14px;
        border-radius: 10px;
        border: 0;
        font-weight: 800;
        cursor: pointer;
      }
      .modal .btn-confirm {
        background: #ff7a00;
        color: #111;
      }
      .modal .btn-cancel {
        background: #6b7280;
        color: #fff;
      }
      .modal .btn:focus-visible {
        outline: 0;
        box-shadow: 0 0 0 3px rgba(255, 208, 151, 0.55);
      }

      /* File inputs (productos + stock): ocultar texto y dejar solo el botón */
      .p-file,
      .s-file {
        width: 160px;
        font-size: 0; /* <- oculta el texto del lado derecho */
        max-width: none;
        color: transparent;
        border: 0;
        outline: none;
        padding: 0;
        background: transparent;
        overflow: hidden;
        white-space: nowrap;
        display: inline-block; /* asegura que respete el ancho */
        cursor: pointer;
      }

      .p-file::file-selector-button,
      .s-file::file-selector-button {
        width: 160px;
        height: 40px;
        padding: 8px 12px;
        border-radius: 10px;
        border: 0;
        background: #ff7a00;
        color: #111;
        font: inherit;
        font-size: 15px; /* el botón sí tiene fuente */
        line-height: 24px;
        cursor: pointer;
        -webkit-appearance: none;
        appearance: none;
      }

      .p-file:focus-within::file-selector-button,
      .s-file:focus-within::file-selector-button {
        box-shadow: 0 0 0 3px rgba(255, 208, 151, 0.55);
      }
      .btn-upload {
        width: 160px;
        height: 40px;
        padding: 8px 12px;
        border: 0;
        border-radius: 10px;
        background: #ff7a00;
        color: #111;
        font: inherit;
        font-size: 15px;
        line-height: 24px;
        cursor: pointer;
      }
      .btn-upload:focus-visible {
        outline: 0;
        box-shadow: 0 0 0 3px rgba(255, 208, 151, 0.55);
      }
      /* === Unifico scroll en móvil (un solo scroller dentro de #app) === */
      #app {
        overflow-x: auto;
      } /* el contenedor principal scrollea */
      #app .card {
        overflow: visible;
      } /* evita scroll secundario en hijos */

      /* El panel de stock NO debe verse como tarjeta independiente */
      .card #stock-admin {
        background: transparent;
        border: 0;
        padding: 0;
      }

      /* Ambos listados tengan el mismo ancho mínimo para el scroll */
      #prod-rows,
      #stock-rows {
        min-width: 1120px;
      }
      /* === Encabezados de listas (Productos / Stock) === */
      .grid-head {
        display: grid;
        gap: 8px;
        align-items: center;
        margin: 6px 0 4px;
        position: sticky;
        top: 0;
        z-index: 3;
        background: #0b0b0b;
        min-width: 1120px;
        width: 100%;
      }

      .grid-head > * {
        box-sizing: border-box; /* padding/borde NO agrandan la columna */
        width: 100%; /* llena su pista del grid */
        min-width: 0; /* permite encoger como la fila */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .grid-head span {
        display: block;
        font-weight: 800;
        font-size: 13px;
        padding: 8px 10px;
        border-radius: 8px;
        background: #0b0b0b;
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: #e5e7eb;
      }

      /* Encabezado Productos: “Nombre del producto” más largo */
      .prod-head {
        /* ID | Categoría | Nombre | Precio | Stock | Foto | Acciones */
        grid-template-columns: 90px 160px 360px 120px 100px max-content 160px;
      }

      /* Encabezado Stock/Fotos: “Nombre del producto” más largo */
      .stock-head {
        /* Nombre | Orden | Visible | Foto | Acciones */
        grid-template-columns: 420px 100px 90px max-content 160px;
      }

      /* Móvil: header = mismas columnas que las filas (valores fijos de JS) */
      @media (max-width: 1200px) {
        .prod-head {
          grid-template-columns: 90px 160px 360px 120px 100px max-content 160px;
        }
        .stock-head {
          grid-template-columns: 420px 100px 90px max-content 160px;
        }
      }
      /* FIX: respetar [hidden] del diálogo viejo */
      .dlg-overlay[hidden] {
        display: none !important;
        pointer-events: none !important;
        opacity: 0 !important;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="wrap">
      <!-- Vista de login mínima (con <form>) -->
      <div id="login-view" class="card">
        <h2>Ingresar</h2>
        <form id="admin-login-form" class="row">
          <input id="email" type="email" placeholder="Email" required />
          <input
            id="password"
            type="password"
            placeholder="Contraseña"
            required
          />
          <button type="submit">Entrar</button>
        </form>
        <p class="muted">Ingresá con tu usuario y contraseña.</p>
      </div>
      <div id="admin-app" style="display: none">
        <div class="card" id="app">
          <div class="row" style="justify-content: space-between">
            <h2 style="margin: 0">Indumentaria / Productos</h2>
          </div>
          <div class="row" style="margin: 8px 0; gap: 8px">
            <button id="add">+ Nuevo</button>
            <button id="logout" style="background: #444; color: #fff">
              Salir
            </button>
          </div>

          <!-- === PRODUCTOS (ADMIN) — misma UI que Stock === -->
          <!-- Encabezado de columnas -->
          <div class="grid-head prod-head">
            <span>ID</span>
            <span>Categoría</span>
            <span>Nombre del producto</span>
            <span>Precio</span>
            <span>Stock</span>
            <span>Foto</span>
            <span>Acciones</span>
          </div>

          <!-- Filas -->
          <div id="prod-rows"></div>

          <!-- === MEDIA POR PRODUCTO === -->
          <section id="pm-admin" class="card" style="margin-top: 24px">
            <h2>Galería por producto</h2>

            <!-- Controles: producto/recargar -->
            <div class="pm-ctrls pm-ctrls--product">
              <label>
                <span>Producto</span>
                <select id="pm-product"></select>
              </label>
              <button id="pm-reload" class="btn">Recargar</button>
            </div>

            <!-- Carga de imágenes -->
            <div class="pm-ctrls pm-ctrls--imgs">
              <label>
                <span>Imágenes (múltiples)</span>
                <input
                  id="pm-imgs"
                  type="file"
                  accept="image/*"
                  multiple
                  class="p-file"
                />
              </label>

              <label>
                <span>Caption (opcional)</span>
                <input
                  id="pm-img-caption"
                  placeholder="Ej: detalle, ángulo, etc."
                />
              </label>

              <label>
                <span>Orden</span>
                <input
                  id="pm-img-sort"
                  type="number"
                  value="1"
                  min="0"
                  title="Orden"
                />
              </label>

              <div class="pm-actions">
                <button id="pm-upload-imgs" class="btn btn-cta">
                  Subir imágenes
                </button>
              </div>
            </div>

            <!-- Carga de video -->
            <div class="pm-ctrls pm-ctrls--video">
              <label>
                <span>Video</span>
                <input
                  id="pm-video"
                  type="file"
                  accept="video/*"
                  class="p-file"
                />
              </label>

              <label>
                <span>Poster (opcional)</span>
                <input
                  id="pm-poster"
                  type="file"
                  accept="image/*"
                  class="p-file"
                />
              </label>

              <label>
                <span>Caption video</span>
                <input id="pm-vid-caption" placeholder="Breve descripción" />
              </label>

              <label>
                <span>Orden</span>
                <input
                  id="pm-vid-sort"
                  type="number"
                  value="3"
                  min="0"
                  title="Orden"
                />
              </label>

              <div class="pm-actions">
                <button id="pm-upload-video" class="btn btn-cta">
                  Subir video
                </button>
              </div>
            </div>

            <!-- Preview local (antes de subir) -->
            <div id="pm-previews" class="pm-previews" hidden>
              <h3>Previsualización (no subido aún)</h3>
              <div id="pm-preview-list" class="pm-preview-list"></div>
            </div>

            <!-- Tabla de media -->
            <table
              class="pm-table"
              style="
                width: 100%;
                margin-top: 12px;
                border-collapse: separate;
                border-spacing: 0;
              "
            >
              <colgroup>
                <col style="width: 72px" />
                <col style="width: 88px" />
                <col />
                <col style="width: 96px" />
                <col style="width: 96px" />
                <col style="width: 220px" />
              </colgroup>
              <thead>
                <tr>
                  <th>Thumb</th>
                  <th>Tipo</th>
                  <th>Caption</th>
                  <th>Orden</th>
                  <th>Visible</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="pm-rows"></tbody>
            </table>
          </section>

          <!-- === STOCK REAL / FOTOS (ADMIN) === -->
          <section id="stock-admin" style="margin-top: 24px">
            <h2>Stock real / Fotos</h2>
            <button id="stock-new" class="btn btn-cta" style="margin: 8px 0">
              + Nuevo Stock / Foto
            </button>

            <!-- Encabezado de columnas -->
            <div class="grid-head stock-head">
              <span>Nombre del producto</span>
              <span>Orden</span>
              <span>Visible</span>
              <span>Foto</span>
              <span>Acciones</span>
            </div>

            <!-- Filas -->
            <div id="stock-rows"></div>
          </section>
          <!--/#stock-admin-->

          <p class="muted">
            Categorías válidas: Buzo polar, Pantalones / Bermudas cargo,
            Remeras, Gorras; Ópticas, Linternas, Municiones; Yerberas, Termos,
            Vasos térmicos.
          </p>
        </div>
      </div>
      <!-- /#admin-app -->
    </div>

    <script>
      const SUPABASE_URL = "https://vtdwtjxadqtmwwhjjhey.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0ZHd0anhhZHF0bXd3aGpqaGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MTE2MjcsImV4cCI6MjA3NTA4NzYyN30.Hqz6S3MvccPgOwavAnA19cf-1mrtzLE_fd5RAqAs7hk";
      const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      function showToast(msg) {
        let t = document.getElementById("toast");
        if (!t) {
          t = document.createElement("div");
          t.id = "toast";
          t.className = "toast";
          document.body.appendChild(t);
        }
        t.textContent = msg;
        t.classList.add("show");
        clearTimeout(t._to);
        t._to = setTimeout(() => t.classList.remove("show"), 1500);
      }
      // Botón "Elegir archivo" -> dispara el input oculto
      document.addEventListener("click", (e) => {
        const btn = e.target.closest(".btn-upload");
        if (!btn) return;
        const fid = btn.getAttribute("data-for");
        document.getElementById(fid)?.click();
      });

      function confirmDialog(message, title = "Confirmar") {
        return new Promise((resolve) => {
          // backdrop
          const back = document.createElement("div");
          back.className = "modal-backdrop";
          back.tabIndex = -1;

          // modal
          const box = document.createElement("div");
          box.className = "modal";
          box.innerHTML = `
      <h3>${title}</h3>
      <p>${message}</p>
      <div class="actions">
        <button class="btn btn-cancel">Cancelar</button>
        <button class="btn btn-confirm">Borrar</button>
      </div>
    `;
          back.appendChild(box);
          document.body.appendChild(back);

          const onClose = (val) => {
            back.remove();
            resolve(val);
          };

          // clicks (delegado): confirma/cancela y NO cierra por click fuera
          back.addEventListener("click", (e) => {
            if (e.target.closest(".btn-confirm")) return onClose(true);
            if (e.target.closest(".btn-cancel")) return onClose(false);
            if (e.target === back) return; // click fuera: no hace nada
          });
          // cerrar con ESC
          back.addEventListener("keydown", (e) => {
            if (e.key === "Escape") onClose(false);
          });

          // foco accesible
          box.querySelector(".btn-cancel").focus();
        });
      }
      // Modal de aviso simple (mismo estilo)
      function infoDialog(message, title = "Aviso") {
        return new Promise((resolve) => {
          const back = document.createElement("div");
          back.className = "modal-backdrop";
          back.tabIndex = -1;

          const box = document.createElement("div");
          box.className = "modal";
          box.innerHTML = `
      <h3>${title}</h3>
      <p>${message}</p>
      <div class="actions">
        <button class="btn btn-confirm">Aceptar</button>
      </div>
    `;
          back.appendChild(box);
          document.body.appendChild(back);

          const onClose = () => {
            back.remove();
            resolve(true);
          };

          box.querySelector(".btn-confirm").onclick = onClose;
          back.onkeydown = (e) => (e.key === "Escape" ? onClose() : null);
          // bloquear click fuera (no cierra)
          back.addEventListener("click", (e) => {
            if (e.target === back) return; // ignora click fuera
          });
          // foco accesible
          box.querySelector(".btn-confirm").focus();
        });
      }

      // Categorías dinámicas desde Supabase con fallback
      // lista fija de categorías (ajustada a tres secciones)
      const CATEGORIES = [
        "Buzo polar",
        "Pantalones / Bermudas cargo",
        "Remeras",
        "Gorras",

        "Ópticas",
        "Linternas",
        "Municiones",

        "Yerberas",
        "Termos",
        "Vasos térmicos",
      ];

      // (removido) Recargar categorías – botón eliminado

      let LAST_MAX_ID = 0; // voy a guardar el último ID usado
      // === Login con Supabase Auth (NUEVO) ===
      const loginView = document.getElementById("login-view");
      const appView = document.getElementById("admin-app");

      // Muestra/oculta vistas según sesión; si hay sesión, carga la UI del admin
      async function refreshUI() {
        const {
          data: { session },
        } = await supa.auth.getSession();
        if (session) {
          loginView.style.display = "none";
          appView.style.display = "block";
          // categorías fijas
          listProductsAdmin();
          listStockAdmin();
        } else {
          appView.style.display = "none";
          loginView.style.display = "block";
        }
      }

      // Submit del formulario de login
      document
        .getElementById("admin-login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;
          const { error } = await supa.auth.signInWithPassword({
            email,
            password,
          });
          if (error) {
            alert(error.message || "Login inválido");
            return;
          }
          refreshUI();
        });

      // Botón Salir (logout)
      document.getElementById("logout").addEventListener("click", async () => {
        await supa.auth.signOut();
        refreshUI();
      });

      // Al cargar la página: decide qué mostrar
      refreshUI();

      // ====== (Opcional) utilitario: actualizar stock desde el admin autenticado ======
      async function updateStock(id, restarCantidad) {
        const { data: prod, error: e1 } = await supa
          .from("products")
          .select("stock")
          .eq("id", id)
          .single();
        if (e1) {
          alert("No pude leer stock");
          return;
        }

        const nuevoStock = Math.max(
          0,
          (prod?.stock ?? 0) - Math.max(1, restarCantidad | 0)
        );

        const { error: e2 } = await supa
          .from("products")
          .update({ stock: nuevoStock })
          .eq("id", id);
        if (e2) {
          alert("No se pudo actualizar stock");
          return;
        }

        alert(`Stock actualizado a ${nuevoStock}`);
      }

      // === PRODUCTOS (ADMIN) — misma UI que "Stock real / Fotos" ===
      const PRODUCTS_BUCKET = "products";
      const $prodRows = document.getElementById("prod-rows");

      function productRow(item = {}) {
        const id = item.id ?? "";
        const category = item.category ?? CATEGORIES[0];
        const name = item.name ?? "";
        const price = item.price ?? 0;
        const stock = item.stock ?? 0;
        const image_url = item.image_url ?? "";
        const fid = `pf-${id || "new"}-${Math.random()
          .toString(36)
          .slice(2, 7)}`;

        return `
  <div class="row" data-id="${id}" data-img="${image_url || ""}"
       style="display:grid;grid-template-columns:90px 160px 360px 120px 100px max-content 160px;gap:8px;align-items:center;margin:10px 0;">

    <input class="p-id" type="number" value="${id}" ${
          id ? "disabled" : ""
        } title="ID">
    <select class="p-cat">
      ${CATEGORIES.map(
        (c) =>
          `<option value="${c}" ${
            c === category ? "selected" : ""
          }>${c}</option>`
      ).join("")}
    </select>
    <input class="p-name"  placeholder="Título" value="${name}">
    <input class="p-price" type="number" min="0" value="${price}">
    <input class="p-stock" type="number" min="0" value="${stock}">
    <div style="display:flex;gap:8px;align-items:center;">
      ${
        image_url
          ? `<img src="${image_url}" style="width:40px;height:40px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.12);">`
          : `<div style="width:40px;height:40px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:#111"></div>`
      }
      <input id="${fid}" class="p-file" type="file" accept="image/*" style="display:none">
<button type="button" class="btn-upload" data-for="${fid}">Elegir archivo</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:end;">
      <button class="p-save">Guardar</button>
      ${
        id
          ? `<button class="p-del" style="background:#6b7280;color:#fff;">Borrar</button>`
          : ""
      }
    </div>
  </div>`;
      }

      async function listProductsAdmin() {
        const { data, error } = await supa
          .from("products")
          .select("*")
          .order("id", { ascending: true });
        if (error) {
          alert(error.message);
          return;
        }

        LAST_MAX_ID = (data || []).reduce(
          (max, r) => Math.max(max, r.id || 0),
          0
        );
        $prodRows.innerHTML = (data || []).map(productRow).join("");
      }

      // Botón “+ Nuevo”: inserta una fila vacía arriba con el próximo ID sugerido
      document.getElementById("add").onclick = () => {
        $prodRows.insertAdjacentHTML(
          "afterbegin",
          productRow({ id: LAST_MAX_ID + 1, stock: 0, price: 0 })
        );
      };

      // Delegación de eventos (Guardar / Borrar) sobre la lista de filas
      $prodRows.addEventListener("click", async (e) => {
        const row = e.target.closest(".row");
        if (!row) return;
        const idEl = row.querySelector(".p-id");
        const id = parseInt(idEl.value, 10);

        // Guardar
        if (e.target.classList.contains("p-save")) {
          const category = row.querySelector(".p-cat").value.trim();
          const name = row.querySelector(".p-name").value.trim();
          const price = parseInt(
            row.querySelector(".p-price").value || "0",
            10
          );
          const stock = parseInt(
            row.querySelector(".p-stock").value || "0",
            10
          );
          if (!id) {
            await infoDialog("Ingresá un ID numérico.", "Dato faltante");
            return;
          }
          if (!category) {
            await infoDialog("Elegí una categoría.", "Dato faltante");
            return;
          }
          if (!name) {
            await infoDialog("Ingresá un título.", "Dato faltante");
            return;
          }

          let image_url = row.getAttribute("data-img") || null;

          const file = row.querySelector(".p-file").files[0];
          if (file) {
            if (!/^image\//.test(file.type))
              return alert("El archivo debe ser una imagen.");
            if (file.size > 8 * 1024 * 1024)
              return alert("La imagen supera 8MB.");
            const cleanName = file.name.replace(/[^\w.\-]+/g, "_");
            const key = `${id}/${Date.now()}_${cleanName}`;
            const up = await supa.storage
              .from(PRODUCTS_BUCKET)
              .upload(key, file, { upsert: true, contentType: file.type });
            if (up.error)
              return alert(up.error.message || "Error subiendo imagen");
            const pub = supa.storage
              .from(PRODUCTS_BUCKET)
              .getPublicUrl(up.data.path);
            image_url = pub.data.publicUrl || image_url;
          }

          const payload = { id, category, name, price, stock, image_url };
          const { error } = await supa
            .from("products")
            .upsert(payload, { onConflict: "id" });
          if (error) return alert(error.message);

          await listProductsAdmin();
          showToast("Guardado");
        }

        // Borrar
        if (e.target.classList.contains("p-del")) {
          const ok = await confirmDialog(
            "¿Querés borrar este producto completo? Esta acción no se puede deshacer.",
            "Borrar producto"
          );
          if (!ok) return;

          const img = row.getAttribute("data-img");
          if (img) {
            const m = img.match(/\/object\/public\/products\/(.+)$/);
            if (m && m[1])
              await supa.storage.from(PRODUCTS_BUCKET).remove([m[1]]);
          }
          const { error } = await supa.from("products").delete().eq("id", id);
          if (error) return alert(error.message);

          row.remove();
          showToast("Eliminado");
        }
      });

      // === STOCK REAL / FOTOS (ADMIN) ===
      const STOCK_BUCKET = "stock"; // o 'products' si preferís reusar ese bucket
      const $stockRows = document.getElementById("stock-rows");
      const $stockNew = document.getElementById("stock-new");

      function stockRow(item) {
        const id = item?.id ?? "";
        const vTitle = item?.title ?? "";
        const vSort = item?.sort ?? 0;
        const vVis = item?.visible ?? true;
        const vUrl = item?.image_url ?? "";
        const fid = `sf-${id || "new"}-${Math.random()
          .toString(36)
          .slice(2, 7)}`;

        return `
 <div class="row" data-id="${id}" style="display:grid;grid-template-columns:420px 100px 90px max-content 160px;gap:8px;align-items:center;margin:10px 0;">
    <input class="s-title" placeholder="Título (opcional)" value="${vTitle}">
    <input class="s-sort"  type="number" value="${vSort}" min="0" title="Orden">
    <label style="display:flex;gap:6px;align-items:center;">
      <input class="s-visible" type="checkbox" ${vVis ? "checked" : ""}> Visible
    </label>
    <div style="display:flex;gap:8px;align-items:center;">

      <img src="${vUrl}" style="width:40px;height:40px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.12);" onerror="this.style.display='none'">
      <input id="${fid}" class="s-file" type="file" accept="image/*" style="display:none">
<button type="button" class="btn-upload" data-for="${fid}">Elegir archivo</button>
    </div>
    <div style="display:flex;gap:8px;justify-content:end;">
      <button class="s-save">Guardar</button>
      <button class="s-del" style="background:#6b7280;color:#fff;">Borrar</button>
    </div>
  </div>`;
      }

      async function listStockAdmin() {
        const { data, error } = await supa
          .from("stock_images")
          .select("*")
          .order("sort", { ascending: true })
          .order("created_at", { ascending: false });
        if (error) {
          console.error(error);
          return;
        }
        $stockRows.innerHTML = (data || []).map(stockRow).join("");
      }

      $stockNew?.addEventListener("click", async () => {
        const { data, error } = await supa
          .from("stock_images")
          .insert({ title: "", image_url: "", sort: 0, visible: true })
          .select()
          .single();
        if (!error) $stockRows.insertAdjacentHTML("afterbegin", stockRow(data));
      });

      // delegación de eventos (save / delete / upload)
      $stockRows?.addEventListener("click", async (e) => {
        const row = e.target.closest(".row");
        if (!row) return;
        const id = row.getAttribute("data-id");

        if (e.target.classList.contains("s-save")) {
          const title = row.querySelector(".s-title").value.trim();
          const sort = parseInt(row.querySelector(".s-sort").value || "0", 10);
          const visible = row.querySelector(".s-visible").checked;

          // ¿archivo nuevo?
          const file = row.querySelector(".s-file").files[0];
          let image_url = null;

          if (file) {
            const path = `${Date.now()}_${file.name}`;
            const up = await supa.storage
              .from(STOCK_BUCKET)
              .upload(path, file, { upsert: true });
            if (up.error) {
              alert("Error subiendo imagen");
              return;
            }
            const pub = supa.storage.from(STOCK_BUCKET).getPublicUrl(path);
            image_url = pub.data.publicUrl;
          }

          const payload = { title, sort, visible };
          if (image_url) payload.image_url = image_url;

          const { error } = await supa
            .from("stock_images")
            .update(payload)
            .eq("id", id);
          if (error) {
            alert("Error guardando");
            return;
          }
          listStockAdmin();
        }

        if (e.target.classList.contains("s-del")) {
          const ok = await confirmDialog(
            "¿Querés borrar esta foto? Esta acción no se puede deshacer.",
            "Borrar producto"
          );
          if (!ok) return;

          const { error } = await supa
            .from("stock_images")
            .delete()
            .eq("id", id);
          if (error) {
            alert("Error borrando");
            return;
          }
          row.remove();
          showToast("Eliminado");
        }
      });
      // === MEDIA POR PRODUCTO (usa el mismo 'supa' ya creado) ===
      const PM_BUCKET = "products";

      const $pmSel = document.getElementById("pm-product");
      const $pmRows = document.getElementById("pm-rows");

      async function pmLoadProducts() {
        const { data, error } = await supa
          .from("products")
          .select("id,name")
          .order("id");
        $pmSel.innerHTML = (data || [])
          .map((p) => `<option value="${p.id}">${p.id} — ${p.name}</option>`)
          .join("");
      }

      function pmSanitize(name) {
        return name.toLowerCase().replace(/[^\w.-]+/g, "-");
      }
      async function pmUploadToBucket(file, pid) {
        const key = `products/${pid}/${Date.now()}-${pmSanitize(file.name)}`;
        const up = await supa.storage
          .from(PM_BUCKET)
          .upload(key, file, { upsert: true, contentType: file.type });
        if (up.error) throw up.error;
        return supa.storage.from(PM_BUCKET).getPublicUrl(up.data.path).data
          .publicUrl;
      }

      async function pmList() {
        const pid = Number($pmSel.value);
        const { data, error } = await supa
          .from("product_media")
          .select("*")
          .eq("product_id", pid)
          .order("sort", { ascending: true })
          .order("created_at", { ascending: true });
        $pmRows.innerHTML = (data || [])
          .map(
            (m) => `
    <tr data-id="${m.id}">
      <td>${
        m.kind === "img"
          ? `<img src="${m.url}" style="width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.12)">`
          : '<span class="muted">video</span>'
      }</td>
      <td>${m.kind}</td>
      <td><input class="pm-cap" value="${m.caption || ""}" /></td>
      <td><input class="pm-sort" type="number" value="${
        m.sort || 0
      }" style="width:80px" /></td>
      <td><input class="pm-vis" type="checkbox" ${
        m.visible ? "checked" : ""
      } /></td>
      <td>
        <button class="pm-save">Guardar</button>
        <button class="pm-del" style="background:#6b7280;color:#fff">Borrar</button>
      </td>
    </tr>`
          )
          .join("");
      }

      document.getElementById("pm-reload").onclick = pmList;
      document.getElementById("pm-upload-imgs").onclick = async () => {
        const pid = Number($pmSel.value);
        const files = Array.from(
          document.getElementById("pm-imgs").files || []
        );
        if (!pid || !files.length) {
          await infoDialog("Elegí producto e imágenes", "Falta información");
          return;
        }

        const cap =
          document.getElementById("pm-img-caption").value.trim() || null;
        const baseSort = Number(
          document.getElementById("pm-img-sort").value || 0
        );

        const rows = [];
        for (let i = 0; i < files.length; i++) {
          const url = await pmUploadToBucket(files[i], pid);
          rows.push({
            product_id: pid,
            kind: "img",
            url,
            poster_url: null,
            caption: cap,
            sort: baseSort + i,
            visible: true,
          });
        }

        await supa.from("product_media").insert(rows);
        document.getElementById("pm-imgs").value = "";

        showToast("Imágenes subidas"); // feedback
        pmList();
      };

      document.getElementById("pm-upload-video").onclick = async () => {
        const pid = Number($pmSel.value);
        const v = document.getElementById("pm-video").files[0];
        if (!pid || !v) {
          await infoDialog(
            "Elegí producto y un archivo de video",
            "Falta información"
          );
          return;
        }
        const p = document.getElementById("pm-poster").files[0] || null;
        const cap =
          document.getElementById("pm-vid-caption").value.trim() || null;
        const sort = Number(document.getElementById("pm-vid-sort").value || 0);

        const vurl = await pmUploadToBucket(v, pid);
        const purl = p ? await pmUploadToBucket(p, pid) : null;

        await supa.from("product_media").insert([
          {
            product_id: pid,
            kind: "video",
            url: vurl,
            poster_url: purl,
            caption: cap,
            sort,
            visible: true,
          },
        ]);

        document.getElementById("pm-video").value = "";
        document.getElementById("pm-poster").value = "";

        showToast("Video subido"); // feedback
        pmList();
      };

      $pmRows.addEventListener("click", async (e) => {
        const tr = e.target.closest("tr[data-id]");
        if (!tr) return;
        const id = Number(tr.dataset.id);

        if (e.target.classList.contains("pm-save")) {
          const caption = tr.querySelector(".pm-cap").value.trim() || null;
          const sort = Number(tr.querySelector(".pm-sort").value || 0);
          const visible = tr.querySelector(".pm-vis").checked;

          await supa
            .from("product_media")
            .update({ caption, sort, visible })
            .eq("id", id);
          showToast("Cambios guardados"); // feedback
          pmList();
        }

        if (e.target.classList.contains("pm-del")) {
          const ok = await confirmDialog(
            "¿Querés borrar este ítem?",
            "Borrar ítem"
          );
          if (!ok) return;
          await supa.from("product_media").delete().eq("id", id);
          showToast("Ítem borrado"); // feedback
          pmList();
        }
      });

      // init del subpanel
      pmLoadProducts().then(pmList);
      $pmSel?.addEventListener("change", pmList);
    </script>

    <!-- Toast -->
    <div id="toast" class="toast"></div>
  </body>
</html>
